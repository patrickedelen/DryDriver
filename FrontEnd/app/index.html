<!DOCTYPE html>
<html lang="en">
<head>

  <script
  src="http://maps.googleapis.com/maps/api/js">
  </script>

<script>
  var loc = document.getElementById("c_location");
  var map;

  function getLocation() {
      if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(showPosition, showError);
      } else { 
          loc.value = "Geolocation is not supported by this browser.";
      }
  }

  function showPosition(position) {
      alert(position.coords.latitude);
      // loc.value = "works";
      document.getElementById("c_location").setAttribute('value', position.coords.latitude + 
      "," + position.coords.longitude);  
  }

  function showError(error) {
      switch(error.code) {
          case error.PERMISSION_DENIED:
              loc.value = "User denied the request for Geolocation."
              break;
          case error.POSITION_UNAVAILABLE:
              loc.value = "Location information is unavailable."
              break;
          case error.TIMEOUT:
              loc.value = "The request to get user location timed out."
              break;
          case error.UNKNOWN_ERROR:
              loc.value = "An unknown error occurred."
              break;
      }
  }
  function initialize() {
    var mapProp = {
      center:new google.maps.LatLng(29,-95),
      zoom:8,
      mapTypeControl: false,
      scaleControl: true,
      streetViewControl: false,
      zoomControl: true,
      zoomControlOptions: {
        position: google.maps.ControlPosition.LEFT_CENTER
      },
      mapTypeId:google.maps.MapTypeId.ROADMAP
    };
    map=new google.maps.Map(document.getElementById("googleMap"), mapProp);
  }
  google.maps.event.addDomListener(window, 'load', initialize);
  </script>


  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0"/>
  <link rel="shortcut icon" href="public/img/logo.png" />
  <title>DryDriver</title>

  <!-- CSS  -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="public/css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="public/css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link href="public/css/drydriver.css" type="text/css" rel="stylesheet" media="screen,projection"/>
</head>
<body> 

  <div id="googleMap""></div>
  <div class="fixed-action-btn horizontal mainAddr">
  <a class="btn-floating btn-large red">
    <i class="large material-icons">menu</i>
  </a>
  <!-- <img src="/img/logo.png" \> -->
    <ul>
      <!-- <li><a class="btn-floating red"><i class="material-icons">share</i></a></li> -->
      <!-- <li><a class="btn-floating yellow darken-1" onclick="myFunction();"><i class="material-icons">format_quote</i></a></li> -->
      <li><a class="btn-floating green"><i class="material-icons" onclick="$('#modal2').openModal();" href="#">share</i></a></li>
      <li><a class="btn-floating blue"><i class="material-icons" onclick="$('#modal1').openModal();" href="#">report_problem</i></a></li>
    </ul>
  </div>
  
  <div class="card z-depth-3" style="margin-left:20%; width:60%;">
  <form action="localhost:8008/route" method="post"enctype="application/x-www-form-urlencoded" id="form-ajax">
    <ul class="collapsible" data-collapsible="accordion">
    <li>
      <div class="collapsible-header"><input id="destination" type="text" name="destination" placeholder="Enter Destination"></div>
      <div class="collapsible-body"><input onclick="getLocation();" id="c_location" type="text" name="origin" placeholder="Current Location"></div>
      <div class="collapsible-body"><button id="route" class="btn-floating btn-medium waves-effect waves-light blue" style="float:right;"><i class="material-icons">navigation</i></button></div>
    </li>
   </ul>
   </form>
  </div>
  <!-- <button onclick="myFunction()">Try it</button> -->
<!-- Modal Structure -->
  <div id="modal1" class="card modal bottom-sheet">
    <div class="modal-content">
      <h4>Report Location</h4>
      <p>Do you want to report your location as flooded?</p>
    </div>
    <div class="modal-footer">
      <a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">Yes</a>
      <a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">No</a>
    </div>
  </div>

  <div id="modal2" class="card modal bottom-sheet">
    <div class="modal-content">
      <h4>Share Location</h4>
      <p>Placeholder for location sharing</p>
    </div>
    <div class="modal-footer">
      <a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">Yes</a>
      <a href="#!" class=" modal-action modal-close waves-effect waves-green btn-flat">No</a>
    </div>
  </div>


  <!--  Scripts-->
  <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
  <script src="public/js/materialize.js"></script>
  <script src="public/js/init.js"></script>
  <script>
  var overlayElem = [];
  var markers = [];
  var routeBoxes = [];

  var startI = 'http://drydriver.pedelen.com/public/img/start.png';
  var endI = 'http://drydriver.pedelen.com/public/img/end.png';
  var warningI = 'http://drydriver.pedelen.com/public/img/warning.png';

    $('#route').click(function() {

      if(overlayElem.routePath) {
        overlayElem.routePath.setMap(null);
      }
      if(overlayElem.startMarker) {
        overlayElem.startMarker.setMap(null);
      }
      if(overlayElem.endMarker) {
        overlayElem.endMarker.setMap(null);
      }

      while(markers[0]) {
        markers.pop().setMap(null);
      }
      while(routeBoxes[0]) {
        routeBoxes.pop().setMap(null);
      }

      console.log('click');
      var origin = document.getElementById('c_location').value;
      var destination = document.getElementById('destination').value;

      var form = $( '#form-ajax');

      var formData = $(form).serialize();

       $.ajax({
                  type: 'POST',
                  url: 'http://drydriver.pedelen.com/route',
                  data: formData
              })
              .done(function(response) {
                map.overlayMapTypes.setAt( 0, null);
                console.log(response);

                var reLine = [];

                response.line.forEach(function(element) {
                  var i = {
                    'lat': element[1],
                    'lng': element[0]
                  };
                  reLine.push(i);
                });

                //polyline for the route
                overlayElem.routePath = new google.maps.Polyline({
                  path: reLine,
                  geodesic: true,
                  strokeColor: '#2456A5',
                  strokeOpacity: 1.0,
                  strokeWeight: 4
                });

                overlayElem.startMarker = new google.maps.Marker({
                  position: reLine[0],
                  icon: startI,
                  map: map
                });
                overlayElem.endMarker = new google.maps.Marker({
                  position: reLine[reLine.length - 1],
                  icon: endI,
                  map: map
                });

                response.pins.forEach(function(element) {
                  //console.log('lat: ' + parseFloat(element.Coordinates[1]) + ' , lng: ' + parseFloat(element.Coordinates[0]))
                  markers.push(new google.maps.Marker({
                    position: {lat: parseFloat(element.Coordinates[1]), lng: parseFloat(element.Coordinates[0])},
                    animation: google.maps.Animation.DROP,
                    title: element.Address,
                    icon: warningI,
                    map: map
                  }));
                });

                response.boxes.forEach(function(element, index) {
                  console.log('Adding box');
                  console.log(element);
                  polyBox = [];
                  element.coordinates[0].forEach(function(elem) {
                    var z = {
                    'lat': parseFloat(elem[1]),
                    'lng': parseFloat(elem[0])
                    };
                    polyBox.push(z);
                  });
                  console.log(polyBox);

                  routeBoxes.push(new google.maps.Polygon({
                      paths: polyBox,
                      strokeColor: '#000000',
                      strokeOpacity: 0.8,
                      strokeWeight: 2,
                      fillColor: '#000000',
                      fillOpacity: 0.35
                    }));
                    //routeBoxes[index].setMap(map);
                });

                overlayElem.routePath.setMap(map);

              });
    });
  </script>

  </body>
</html>
